<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP32 Console</title>
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      .container {
        max-width: 800px;
        margin: auto;
      }
      .console {
        width: 100%;
        height: 300px;
        border: 1px solid black;
        background: black;
        color: lime;
        padding: 5px;
        overflow: auto;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>ESP32 Console Log</h2>

      <!-- Console ESP32 (UART) -->
      <button id="connectESP">üîå K·∫øt n·ªëi ESP32</button>
      <button id="disconnectESP" disabled>‚ùå Ng·∫Øt k·∫øt n·ªëi</button>
      <div id="serialConsole" class="console"></div>

      <!-- Console WebREPL -->
      <h2>ESP32 WebREPL</h2>
      <input type="text" id="commandInput" placeholder="Nh·∫≠p l·ªánh WebREPL..." />
      <button id="sendCommand">üì© G·ª≠i L·ªánh</button>
      <button id="connectWebREPL">üîó K·∫øt n·ªëi WebREPL</button>
      <div id="webreplConsole" class="console"></div>
    </div>

    <script>
      let port,
        reader,
        decoder = new TextDecoder();
      let webreplSocket;

      // üîå K·∫øt n·ªëi ESP32 qua Serial
      document
        .getElementById("connectESP")
        .addEventListener("click", async () => {
          try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });
            logMessage("‚úÖ K·∫øt n·ªëi ESP32 th√†nh c√¥ng!", "serialConsole");
            readSerialData();
            document.getElementById("disconnectESP").disabled = false;
          } catch (error) {
            logMessage("‚ùå L·ªói k·∫øt n·ªëi: " + error.message, "serialConsole");
          }
        });

      // ‚ùå Ng·∫Øt k·∫øt n·ªëi ESP32
      document
        .getElementById("disconnectESP")
        .addEventListener("click", async () => {
          if (port) {
            await port.close();
            logMessage("‚úÖ ƒê√£ ng·∫Øt k·∫øt n·ªëi ESP32!", "serialConsole");
            document.getElementById("disconnectESP").disabled = true;
          }
        });

      // üì© ƒê·ªçc d·ªØ li·ªáu t·ª´ ESP32 (UART)
      async function readSerialData() {
        reader = port.readable.getReader();
        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            logMessage(decoder.decode(value), "serialConsole");
          }
        } catch (error) {
          logMessage("‚ùå L·ªói ƒë·ªçc d·ªØ li·ªáu: " + error.message, "serialConsole");
        }
      }

      // üîó K·∫øt n·ªëi WebREPL
      document
        .getElementById("connectWebREPL")
        .addEventListener("click", () => {
          const esp32Ip = prompt("Nh·∫≠p IP c·ªßa ESP32:", "192.168.1.29");
          webreplSocket = new WebSocket(`ws://${esp32Ip}:8266`);

          webreplSocket.onopen = () =>
            logMessage("‚úÖ K·∫øt n·ªëi WebREPL th√†nh c√¥ng!", "webreplConsole");
          webreplSocket.onmessage = (event) =>
            logMessage(event.data, "webreplConsole");
          webreplSocket.onerror = (error) =>
            logMessage("‚ùå L·ªói k·∫øt n·ªëi: " + error.message, "webreplConsole");
        });

      // üì© G·ª≠i l·ªánh WebREPL
      document.getElementById("sendCommand").addEventListener("click", () => {
        const command = document.getElementById("commandInput").value;
        if (webreplSocket && webreplSocket.readyState === WebSocket.OPEN) {
          webreplSocket.send(command + "\n");
          logMessage("üì© ƒê√£ g·ª≠i: " + command, "webreplConsole");
        } else {
          logMessage("‚ùå Ch∆∞a k·∫øt n·ªëi WebREPL!", "webreplConsole");
        }
      });

      // üìå Ghi log v√†o giao di·ªán
      function logMessage(message, consoleId) {
        let consoleDiv = document.getElementById(consoleId);
        consoleDiv.innerHTML += message + "<br>";
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
      }
    </script>
  </body>
</html>
