<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <input type="file" id="firmwareFile" accept=".bin" />
    <button onclick="uploadFirmware()">Upload</button>

    <script>
      function uploadFirmware() {
        const file = document.getElementById("firmwareFile").files[0];
        if (file) sendFirmware(file);
      }
    </script>

    <script>
      if ("serial" in navigator) {
        console.log("‚úÖ Tr√¨nh duy·ªát c·ªßa b·∫°n h·ªó tr·ª£ Web Serial API!");
      } else {
        console.log("‚ùå Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Web Serial API!");
      }
      let port;

      async function connectToESP32() {
        try {
          port = await navigator.serial.requestPort(); // Ch·ªçn c·ªïng COM c·ªßa ESP32
          await port.open({ baudRate: 115200 }); // T·ªëc ƒë·ªô baud ph·ªï bi·∫øn c·ªßa ESP32
          console.log("‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!");
        } catch (error) {
          console.error("‚ùå L·ªói k·∫øt n·ªëi:", error);
        }
      }
      async function sendCommand(command) {
        if (!port) {
          console.error("‚ùå Ch∆∞a k·∫øt n·ªëi v·ªõi ESP32!");
          return;
        }

        const writer = port.writable.getWriter();
        const encoder = new TextEncoder();
        await writer.write(encoder.encode(command + "\n"));
        writer.releaseLock();

        console.log("üì© ƒê√£ g·ª≠i l·ªánh:", command);
      }
      sendCommand("AT+RST");
      async function readResponse() {
        if (!port) {
          console.error("‚ùå Ch∆∞a k·∫øt n·ªëi v·ªõi ESP32!");
          return;
        }

        const reader = port.readable.getReader();
        const decoder = new TextDecoder();

        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            console.log("üì© ESP32:", decoder.decode(value));
          }
        } catch (error) {
          console.error("‚ùå L·ªói ƒë·ªçc d·ªØ li·ªáu:", error);
        } finally {
          reader.releaseLock();
        }
      }
      readResponse();
      async function sendFirmware(file) {
        if (!port) {
          console.error("‚ùå Ch∆∞a k·∫øt n·ªëi v·ªõi ESP32!");
          return;
        }

        const reader = new FileReader();
        reader.readAsArrayBuffer(file);

        reader.onload = async function () {
          const writer = port.writable.getWriter();
          await writer.write(new Uint8Array(reader.result));
          writer.releaseLock();
          console.log("‚úÖ ƒê√£ g·ª≠i firmware th√†nh c√¥ng!");
        };

        reader.onerror = function () {
          console.error("‚ùå L·ªói ƒë·ªçc file firmware!");
        };
      }
      async function disconnectESP32() {
        if (port) {
          await port.close();
          port = null;
          console.log("‚úÖ ƒê√£ ng·∫Øt k·∫øt n·ªëi ESP32!");
        }
      }
    </script>
  </body>
</html>
